---
layout: post
title: mongoDB
date: 2022-10-10
categories: 后端开发
tags: [数据库, mongoDB, 增删查改]
---

## 简介

MongoDB是一个基于分布式文件存储的数据库。由C++语言编写，旨在为WEB应用提供可扩展的高性能数据存储解决方案。MongoDB是一个介于关系型数据库和非关系型数据库之间的产品，是非关系型数据库当中功能最丰富，最像关系型数据库的。

## 基本操作

#### 数据库操作

创建数据库
```
> use test
switched to db test
> db.article.insert({name:"MongoDB 教程"})
WriteResult({ "nInserted" : 1 })
> show dbs
admin   0.000GB
config  0.000GB
local   0.000GB
test    0.000GB
```

删除数据库
```
> db.dropDatabase()
{ "dropped" : "test", "ok" : 1 }
> show dbs
admin   0.000GB
config  0.000GB
local   0.000GB
```

#### 集合(表)操作

创建集合
```
> use test
switched to db test
> db.createCollection("article")
{ "ok" : 1 }
> show collections
article
```

删除集合
```
> db.article.drop()
true
> show collections
```

#### 文档(数据行)操作

插入文档
```
db.collection.insert(document)

db.article.insert({title: 'MongoDB 教程', 、
    description: 'MongoDB 是一个 Nosql 数据库',
    by: 'Andy',
    url: 'https://www.mongodb.com/',
    tags: ['mongodb', 'database', 'NoSQL'],
    likes: 100
})

insertMany([])
```

更新文档
```
db.collection.update(
   <query>,
   <update>,
   {
     multi: <boolean>
   }
)
# query：修改的查询条件，类似于SQL中的WHERE部分
# update：更新属性的操作符，类似与SQL中的SET部分
# multi：设置为true时会更新所有符合条件的文档，默认为false只更新找到的第一条

db.article.update({'title':'MongoDB 教程'},{$set:{'title':'MongoDB'}},{multi:true})

updateOne()

updateMany()

save() 直接替换已有文档,不存在则插入，根据_id判断重复

db.article.save({
    "_id" : ObjectId("5e9943661379a112845e4056"),
    "title" : "MongoDB 教程",
    "description" : "MongoDB 是一个 Nosql 数据库",
    "by" : "Andy",
    "url" : "https://www.mongodb.com/",
    "tags" : [
        "mongodb",
        "database",
        "NoSQL"
    ],
    "likes" : 100.0
})

replaceOne()
```

删除文档
```
db.collection.remove(
   <query>,
   {
     justOne: <boolean>
   }
)
# query：删除的查询条件，类似于SQL中的WHERE部分
# justOne：设置为true只删除一条记录，默认为false删除所有记录

db.article.remove({'title':'MongoDB 教程'})
```

查询文档
```
db.collection.find(query, projection)
# query：查询条件，类似于SQL中的WHERE部分
# projection：可选，使用投影操作符指定返回的键

db.article.find()

findOne()
```

#### 条件操作符

| 操作 |	格式 | SQL中的类似语句 |
| -- | -- | -- |
| 等于 | { aa:'测试'} | where title = 'MongoDB 教程' |
| 小于 | { aa:{$lt:'测试'} | where likes < 50 |
| 小于或等于 | {aa:{$lte:'测试'} | where likes <= 50 |
| 大于 | { aa:{$gt:'测试'} | where likes > 50 |
| 大于或等于 | { aa:{$gte:'测试'} | where likes >= 50 |
| 不等于 | { aa:{$ne:'测试'} | where likes != 50 |

#### 其他操作

读取指定数量的文档，可以使用limit()方法
`db.article.find().limit(2)`

跳过指定数量的文档来读取，可以使用skip()方法
`db.collection.find().limit(12).skip(12)`

排序sort(),指定排序的字段，1为升序，-1为降序
`db.collection.find().sort({KEY:1})`

createIndex()方法来创建索引，1为升序，-1为降序索引，以后台方式创建
`db.article.createIndex({"title":1,"description":-1}, {background: true})`

查看article集合中已经创建的索引
`db.article.getIndexes()`

聚合使用aggregate()方法，类似于SQL中的group by语句
`db.collection.aggregate(AGGREGATE_OPERATION)`

聚合常用操作符

| 操作 | 操作 |
| -- | -- |
| $sum | 计算总数 |
| $avg | 计算平均数 |
| $min | 计算最小数 |
| $max | 计算最大数 |

根据by字段聚合文档并计算likes字段的平局值，类似SQL中的avg()语句
```
db.users.aggregate( [
   {
    $match:{
      price:{
        $gt:NumberDecimal("10")
        }
      }
   },
   {
     $group:
       {
         _id: "$tags",
         averageQty: { $avg: "$qty" }
       }
   },
   { $sort: { "averageQty": -1 } },
   { $skip: 2},
   { $limit: 2},
   { $project : { _id : 1 , totalSaleAmount : 1 } }
] )
```

$regex操作符来设置匹配字符串的正则表达式，可以用来模糊查询，类似于SQL中的like操作

`db.article.find({title:{$regex:"教程"}})`

不区分大小写的模糊查询
`db.article.find({title:{$regex:"elasticsearch",$options:"$i"}})`